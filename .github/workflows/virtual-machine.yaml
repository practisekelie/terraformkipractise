name: "VM-creation"

on: 
 workflow_dispatch:

permissions:
    id-token: write
    contents: read
jobs:
  TerraformInit: 
    name: Init and plan
    runs-on: vm-runner-1
    steps:
      - name: Checkout
        uses: actions/checkout@v5.0.0 
        with:
            repository: practisekelie/terraformkipractise

      - name: Install Terraform
        uses: little-core-labs/install-terraform@v2.0.0
        with:
          version: 1.8.5

      - name: Azure Login
        uses: Azure/login@v2.3.0
        with:
            client-id: a44c7ebc-62e6-4480-ae4b-d4c88771189b
            tenant-id: 96e40700-6303-4437-a677-c0d7f1f5eb24
            subscription-id: dfad8f6a-4ed1-4448-b795-d396ad2c60db
            
      - name: Terraform fmt
        id: fmt
        run: terraform fmt -check
        continue-on-error: true

      - name: Terraform Init
        id: init
        run: terraform init -input=false

      - name: Terraform Validate
        id: validate
        run: terraform validate -no-color
        
      - name: Terraform Plan
        id: plan
        run: terraform plan -no-color -input=false
        continue-on-error: true
  jobs:
      name: Run tfsec
      runs-on: ubuntu-latest
      needs: TerraformInit 
      steps:
        - name: Checkout repository
          uses: actions/checkout@v3

        - name: Run tfsec
          uses: aquasecurity/tfsec-action@v1.0.0
          with:
            args: --format csv --out tfsec_results.csv
  TerraformApply: 
     name: Apply
     runs-on: vm-runner-1
     environment: test
     needs: TerraformInit
     steps:
        - name: Checkout
          uses: actions/checkout@v5.0.0 
    
        - name: Install Terraform
          uses: little-core-labs/install-terraform@v2.0.0
          with:
            version: 1.8.5
        - name: Azure Login
          uses: Azure/login@v2.3.0
          with:
                client-id: a44c7ebc-62e6-4480-ae4b-d4c88771189b
                tenant-id: 96e40700-6303-4437-a677-c0d7f1f5eb24
                subscription-id: dfad8f6a-4ed1-4448-b795-d396ad2c60db
        
        - name: Terraform Init
          id: init
          run: terraform init -input=false  
      
        - name: Terraform Plan
          id: plan
          run: terraform plan -no-color -input=false
          continue-on-error: true
    
        - name: Terraform Apply
          id: Apply
          run: terraform apply --auto-approve
          continue-on-error: true
    
